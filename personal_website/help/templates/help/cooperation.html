<!DOCTYPE html>

{% load static %}
{% load project_extras %}

<html lang="en-US">
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width"/>
        <title>{{follow.request.title}}</title>
        <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
        <script src="https://unpkg.com/element-ui/lib/index.js"></script>
        <style>
            * {margin: 0; padding: 0}

            .preview_document {
                color: #606266;
                font-size: 13px;
                line-height: 200%;
            }

            .preview_document h1 {
                color: #303133;
                font-size: 18px;
                line-height: 250%;
            }

            .preview_document h2 {
                color: #606266;
                font-size: 16px;
            }

            .preview_document h3 {
                color: #606266;
                font-size: 14px;
            }

            .chat-msg {
                background-color: #409EFF;
                padding:8px;
                margin:8px;
                color: white;
                font-size: 14px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, .12), 0 0 6px rgba(0, 0, 0, .04);
                max-width: 70%;
            }

            body {
                background-color: #F2F6FC
            }
        </style>
    </head>

    <body>
        <div id="app" style="display: flex;">

            <el-dialog title="填写申诉原因" :visible.sync="appeal_dialog_visible" width="70%">
                <el-form :model="appeal_form_model" ref="appeal_form" label-width="80px" :rules="appeal_form_rules">
                    <el-form-item label="手机号码" prop="mobile">
                        <el-input type="text" placeholder="请输入手机号码" v-model="appeal_form_model.mobile" maxlength="11" minlength="11"></el-input>
                    </el-form-item>
                    <el-form-item label="申诉原因" prop="reason">
                        <el-input type="textarea" placeholder="请输入内容" v-model="appeal_form_model.reason" maxlength="200" show-word-limit></el-input>
                    </el-form-item>
                    <el-form-item label="期望结果" prop="result">
                        <el-input type="textarea" placeholder="请输入内容" v-model="appeal_form_model.result" maxlength="200" show-word-limit></el-input>
                    </el-form-item>
                    <el-form-item>
                        <el-button type="primary" @click="submitAppeal">提交申诉</el-button>
                        <el-button @click="appeal_dialog_visible = false">取消</el-button>
                    </el-form-item>
                </el-form>
            </el-dialog>

            <el-dialog title="取消合作" :visible.sync="cancel_confirm_visible" width="70%">
                {% if cooperation.active >= 2 %}
                <span>如果取消合作，<strong>将不会退还您的 {{0.1|mul:cooperation.follow.bid_price}} 元押金</strong>。您确定要继续取消合作吗？</span>
                {% else %}
                <span>取消合作将不会对您产生任何不利影响。您确定要继续取消合作吗？</span>
                {% endif %}
                <div style="padding-top: 20px; display:flex; align-items: center; justify-content: center;">
                    <el-button type="primary" @click="cancel_confirm_visible = false">再想想</el-button>
                    <el-button type="danger" @click="submitCancelCooperation">仍要取消</el-button>
                </div>
            </el-dialog>

            <el-dialog title="需求文档预览" :visible.sync="document_visible" width="70%">
                <div v-html="html_document" class="preview_document"></div>
            </el-dialog>

            <el-dialog title="支付" :visible.sync="step2_confirm_visible">
                <div style="font-size: 14px; color:#606266; line-height: 200%;">
                    <div>
                        请您主动添加对方微信或支付宝好友，并支付 <strong>{{cooperation.follow.procedure.procedurestep_set.all.2.pay|div:100|mul:cooperation.follow.bid_price}} 元</strong> 作为付款。
                    </div>
                    <div style="margin-top:5px;">
                        支付完成后，请通知对方点击“收到付款”按钮，以便进行下一步操作。
                    </div>
                </div>
                <template>
                    <div style="display: flex; align-items: center; justify-content: center; padding-top:20px;">
                        <el-button plain @click="step2_confirm_visible = false">取消</el-button>
                    </div>
                </template>
            </el-dialog>

            <el-dialog title="支付" :visible.sync="step3_confirm_visible">
                <div style="font-size: 14px; color:#606266; line-height: 200%">
                    <div>
                        请您主动添加对方微信或支付宝好友，并支付 <strong>{{cooperation.follow.procedure.procedurestep_set.all.3.pay|div:100|mul:cooperation.follow.bid_price}} 元</strong> 作为付款。
                    </div>
                    <div style="margin-top: 5px;">
                        支付完成后，请通知对方点击“<strong>收到付款</strong>”按钮，以便进行下一步操作。
                    </div>
                </div>
                <template>
                    <div style="display: flex; align-items: center; justify-content: center; padding-top:20px;">
                        <el-button plain @click="step3_confirm_visible = false">取消</el-button>
                    </div>
                </template>
            </el-dialog>

            <div style="width: 62vw;">
                <div style="box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1); margin: 20px; padding: 20px; background-color: white;">
                    <el-steps :active="active_step" align-center finish-status="success">
                        {% for step in cooperation.follow.procedure.procedurestep_set.all %}
                        <el-step title="{{step.title}}" description="{{step.discription}}"></el-step>
                        {% endfor %}
                    </el-steps>
                </div>
                <div style="box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1); margin: 20px; padding: 20px; background-color: white;">
                    <div style="display:flex; justify-content: center; align-items:center;padding:20px;padding-top:0; color:#303133;">
                        <span style="font-size: 16px; color:#409EFF;"><i class="el-icon-s-cooperation"></i> 工作台</span>
                    </div>
                    {% if cooperation.is_appeal == True %}
                    <!--当前处于申诉状态-->
                    {% if cooperation.cooperationappealing_set.all.0.is_finished == False %}
                    <!--申诉还没有处理结果-->
                    {% if usr == cooperation.cooperationappealing_set.all.0.initiator %}
                    <el-result icon="warning" title="当前合作正处于申诉状态" sub-title="您已提起申诉，请等待平台处理结果">
                        <template slot="extra">
                            <el-button type="primary" size="medium" @click="cancelAppeal">取消申诉</el-button>
                        </template>
                    </el-result>
                    {% else %}
                    <el-result icon="warning" title="当前合作正处于申诉状态" sub-title="对方已提起申诉，请等待平台处理结果"></el-result>
                    {% endif %}
                    {% else %}
                    <!--申诉已经有了处理结果-->
                    {% if usr == cooperation.cooperationappealing_set.all.0.initiator %}
                    <el-result icon="success" title="申诉已处理" sub-title="{{cooperation.cooperationappealing_set.all.0.result}}"></el-result>
                    {% else %}
                    <el-result icon="success" title="申诉已处理" sub-title="{{cooperation.cooperationappealing_set.all.0.result}}"></el-result>
                    {% endif %}
                    {% endif %}
                    {% else %}
                    {% if cooperation.follow.user == usr %}
                    <!--竞标者-->
                    {% for substep in substeps %}
                    {% if substep.type == 1 %}
                    <div style="margin-bottom: 20px; font-size: 14px; color:#606266"><i class="el-icon-circle-check"></i> {{substep.content}}</div>
                    {% endif %}
                    {% endfor %}
                    {% if cooperation.active == 0 %}
                    <!--第1步-->
                    <el-input :autosize="{minRows: 10}" type="textarea" placeholder="请输入需求文档" v-model="request_document" maxlength="2000" show-word-limit></el-input>
                    <div style="display: flex; align-items:center; justify-content: center; margin-top: 20px;">
                        <el-button @click="previewDocument">预览</el-button>
                        <el-button type="primary" @click="requestDocumentSubmit">提交</el-button>
                        <el-button type="danger" @click="cancel_confirm_visible = true">取消合作</el-button>
                    </div>
                    {% elif cooperation.active == 1 %}
                    <!--第2步-->
                    {% if cooperation.client_deposit != 0 %}
                    <div style="font-size:14px; color: #909399; margin-bottom:20px">对方已经支付押金，请您尽快支付</div>
                    {% endif %}
                    {% if cooperation.server_deposit == 0 %}
                    <div style="font-size:14px; color: #909399; margin-bottom:20px">
                        <span style="margin-right:20px">选择支付方式</span>
                        <el-radio-group v-model="pay_method">
                            <el-radio :label="'alipay'">支付宝</el-radio>
                        </el-radio-group>
                    </div>
                    <div style="text-align: center;">
                        <el-button type="primary" v-html="pay_immediate_html" @click="getDepositPayLink(pay_method)"></el-button>
                        <el-button type="danger" @click="cancel_confirm_visible = true">取消合作</el-button>
                    </div>
                    {% else %}
                    <div style="font-size:14px; color: #909399">您已支付押金，请等待对方完成押金支付</div>
                    {% endif %}
                    {% elif cooperation.active == 2 %}
                    <!--第3步-->
                    <div style="font-size:14px; color: #909399">对方尚未付款，付款后可进入下一环节</div>
                    {% elif cooperation.active == 3 %}
                    <!--第4步-->
                    <div style="font-size:14px; color: #909399">对方尚未点击“部署完成”，点击后可进入下一环节</div>
                    {% elif cooperation.active == 4 %}
                    <!--第5步-->
                    {% if cooperation.serverfeedback_set.all.count == 0 %}
                    <div style="text-align: center;">
                        {% if cooperation.client_cancel == True %}
                        <div style="margin-bottom: 20px;"><span style="font-size: 14px; color:#909399">对方已取消合作，请完成评价</span></div>
                        {% elif cooperation.server_cancel == True %}
                        <div style="margin-bottom: 20px;"><span style="font-size: 14px; color:#909399">您已取消合作，请完成评价</span></div>
                        {% else %}
                        <div style="margin-bottom: 20px;"><span style="font-size: 14px; color:#909399">请完成评价</span></div>
                        {% endif %}
                        <div style="margin-bottom: 20px;"><el-rate v-model="rate"></el-rate></div>
                        <div style="margin-bottom: 20px;"><el-input type="textarea" placeholder="请输入评价" v-model="review" maxlength="100" show-word-limit></el-input></div>
                    </div>
                    <div style="text-align: center;"><el-button type="primary" plain @click="submitRateAndReview"><span v-html="submit_feedback_client"></span></el-button></div>
                    {% elif cooperation.server_cancel == False %}
                    <el-result icon="success" title="感谢您的配合" sub-title="希望有机会与您再次合作"></el-result>
                    {% elif cooperation.server_cancel == True and cooperation.server_deposit > 0 %}
                    <el-result icon="warning" title="合作已取消" sub-title="由于您中途取消了合作，押金将不会被退还"></el-result>
                    {% elif cooperation.server_cancel == True and cooperation.server_deposit == 0 %}
                    <el-result icon="success" title="合作已取消" sub-title="感谢您的支持，我们将始终保护您的权益"></el-result>
                    {% endif %}
                    {% endif %}
                    {% else %}
                    <!--需求者-->
                    {% for substep in substeps %}
                    {% if substep.type == 0 %}
                    <div style="margin-bottom: 20px; font-size: 14px; color:#606266"><i class="el-icon-circle-check"></i> {{substep.content}}</div>
                    {% endif %}
                    {% endfor %}

                    {% if cooperation.active == 0 %}
                    <!--第1步-->
                    {% if cooperation.request_document_update == True %}
                    <el-button @click="previewDocument">查看需求文档</el-button>
                    <el-divider direction="vertical"></el-divider>
                    <span style="font-size:13px; color:#909399">更新时间：{{cooperation.request_document_update_datetime}}</span>
                    {% else %}
                    <el-button disabled>查看需求文档</el-button>
                    <el-divider direction="vertical"></el-divider>
                    <span style="font-size:13px; color:#909399">对方尚未提交需求文档</span>
                    {% endif %}
                    <div style="margin-top:20px; display:flex; justify-content: center; align-items:center;">
                        <el-button type="primary" @click="entryNextSubmit">审阅通过</el-button>
                        <el-button type="danger" @click="cancel_confirm_visible = true">取消合作</el-button>
                    </div>
                    {% elif cooperation.active == 1 %}
                    <!--第2步-->
                    {% if cooperation.server_deposit != 0 %}
                    <div style="font-size:14px; color: #909399; margin-bottom:20px">对方已经支付押金，请您尽快支付</div>
                    {% endif %}
                    {% if cooperation.client_deposit == 0 %}
                    <div style="font-size:14px; color: #909399; margin-bottom:20px">
                        <span style="margin-right:20px">选择支付方式</span>
                        <el-radio-group v-model="pay_method">
                            <el-radio :label="'alipay'">支付宝</el-radio>
                        </el-radio-group>
                    </div>
                    <div style="text-align: center;">
                        <el-button type="primary" v-html="pay_immediate_html" @click="getDepositPayLink(pay_method)"></el-button>
                        <el-button type="danger" @click="cancel_confirm_visible = true">取消合作</el-button>
                    </div>
                    {% else %}
                    <div style="font-size:14px; color: #909399">您已支付押金，请等待对方完成押金支付</div>
                    {% endif %}
                    {% elif cooperation.active == 2 %}
                    <!--第3步-->
                    <div style="display:flex; justify-content: center; align-items: center;">
                        <el-button type="primary" @click="getPayLink" v-html="let_me_pay"></el-button>
                        <el-button type="danger" @click="cancel_confirm_visible = true">取消合作</el-button>
                    </div>
                    {% elif cooperation.active == 3 %}
                    <!--第4步-->
                    <div style="display:flex; justify-content: center; align-items: center;">
                        <el-button type="primary" @click="entryNextSubmit">已完成部署</el-button>
                    </div>
                    {% elif cooperation.active == 4 %}
                    <!--第5步-->
                    {% if cooperation.clientfeedback_set.all.count == 0 %}
                    <div style="text-align: center;">
                        {% if cooperation.server_cancel == True %}
                        <div style="margin-bottom: 20px;"><span style="font-size: 14px; color:#909399">对方已取消合作，请完成评价</span></div>
                        {% elif cooperation.client_cancel == True %}
                        <div style="margin-bottom: 20px;"><span style="font-size: 14px; color:#909399">您已取消合作，请完成评价</span></div>
                        {% else %}
                        <div style="margin-bottom: 20px;"><span style="font-size: 14px; color:#909399">请完成评价</span></div>
                        {% endif %}
                        <div style="margin-bottom: 20px;"><el-rate v-model="rate"></el-rate></div>
                        <div style="margin-bottom: 20px;"><el-input type="textarea" placeholder="请输入评价" v-model="review" maxlength="100" show-word-limit></el-input></div>
                    </div>
                    <div style="text-align: center;"><el-button type="primary" plain @click="submitRateAndReview"><span v-html="submit_feedback_client"></span></el-button></div>
                    {% elif cooperation.client_cancel == False %}
                    <el-result icon="success" title="感谢您的配合" sub-title="希望有机会与您再次合作"></el-result>
                    {% elif cooperation.client_cancel == True and cooperation.client_deposit > 0 %}
                    <el-result icon="warning" title="合作已取消" sub-title="由于您中途取消了合作，押金将不会被退还"></el-result>
                    {% elif cooperation.client_cancel == True and cooperation.client_deposit == 0 %}
                    <el-result icon="success" title="合作已取消" sub-title="感谢您的支持，我们将始终保护您的权益"></el-result>
                    {% endif %}
                    {% endif %}
                    {% endif %}
                    {% endif %}
                </div>
                <div style="box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1); margin: 20px; padding: 20px; background-color: white;">
                    <div style="display:flex; justify-content: center; align-items:center;padding:20px;padding-top:0; color:#303133;">
                        <span style="font-size: 16px; color:#409EFF;"><i class="el-icon-question"></i> Q&A</span>
                    </div>
                    <el-collapse>
                        {% if cooperation.follow.user == usr %}

                        <!--竞标者-->
                        {% if cooperation.active == 0 %}
                        <!--第1步-->
                        <el-collapse-item title="对方联系不上怎么办？" name="1">
                            <div style="color:#606266; margin-left:20px">在这种情况下，建议您耐心等待几天。如果仍然无法联系到对方，您可以考虑进行<el-button type="text" @click="appeal_dialog_visible = true"><span style="font-size:13px">申诉</span></el-button>操作</div>
                        </el-collapse-item>
                        {% elif cooperation.active == 1 %}
                        <!--第2步-->
                        <el-collapse-item title="对方联系不上怎么办？" name="1">
                            <div style="color:#606266; margin-left:20px">在这种情况下，建议您耐心等待几天。如果仍然无法联系到对方，您可以考虑进行<el-button type="text" @click="appeal_dialog_visible = true"><span style="font-size:13px">申诉</span></el-button>操作</div>
                        </el-collapse-item>
                        {% elif cooperation.active == 2 %}
                        <!--第3步-->
                        <el-collapse-item title="对方联系不上怎么办？" name="1">
                            <div style="color:#606266; margin-left:20px">在这种情况下，建议您耐心等待几天。如果仍然无法联系到对方，您可以考虑进行<el-button type="text" @click="appeal_dialog_visible = true"><span style="font-size:13px">申诉</span></el-button>操作</div>
                        </el-collapse-item>
                        {% elif cooperation.active == 3 %}
                        <!--第4步-->
                        <el-collapse-item title="对方联系不上怎么办？" name="1">
                            <div style="color:#606266; margin-left:20px">在这种情况下，建议您耐心等待几天。如果仍然无法联系到对方，您可以考虑进行<el-button type="text" @click="appeal_dialog_visible = true"><span style="font-size:13px">申诉</span></el-button>操作</div>
                        </el-collapse-item>
                        {% elif cooperation.active == 4 %}
                        <!--第5步-->
                        <el-collapse-item title="对方联系不上怎么办？" name="1">
                            <div style="color:#606266; margin-left:20px">在这种情况下，建议您耐心等待几天。如果仍然无法联系到对方，您可以考虑进行<el-button type="text" @click="appeal_dialog_visible = true"><span style="font-size:13px">申诉</span></el-button>操作</div>
                        </el-collapse-item>
                        {% endif %}

                        {% else %}

                        <!--需求方-->
                        {% if cooperation.active == 0 %}
                        <!--第1步-->
                        <el-collapse-item title="对方联系不上怎么办？" name="1">
                            <div style="color:#606266; margin-left:20px">在这种情况下，建议您耐心等待几天。如果仍然无法联系到对方，您可以考虑进行<el-button type="text" @click="appeal_dialog_visible = true"><span style="font-size:13px">申诉</span></el-button>操作</div>
                        </el-collapse-item>
                        {% elif cooperation.active == 1 %}
                        <!--第2步-->
                        <el-collapse-item title="对方联系不上怎么办？" name="1">
                            <div style="color:#606266; margin-left:20px">在这种情况下，建议您耐心等待几天。如果仍然无法联系到对方，您可以考虑进行<el-button type="text" @click="appeal_dialog_visible = true"><span style="font-size:13px">申诉</span></el-button>操作</div>
                        </el-collapse-item>
                        {% elif cooperation.active == 2 %}
                        <!--第3步-->
                        <el-collapse-item title="对方联系不上怎么办？" name="1">
                            <div style="color:#606266; margin-left:20px">在这种情况下，建议您耐心等待几天。如果仍然无法联系到对方，您可以考虑进行<el-button type="text" @click="appeal_dialog_visible = true"><span style="font-size:13px">申诉</span></el-button>操作</div>
                        </el-collapse-item>
                        {% elif cooperation.active == 3 %}
                        <!--第4步-->
                        <el-collapse-item title="对方联系不上怎么办？" name="1">
                            <div style="color:#606266; margin-left:20px">在这种情况下，建议您耐心等待几天。如果仍然无法联系到对方，您可以考虑进行<el-button type="text" @click="appeal_dialog_visible = true"><span style="font-size:13px">申诉</span></el-button>操作</div>
                        </el-collapse-item>
                        {% elif cooperation.active == 4 %}
                        <!--第5步-->
                        <el-collapse-item title="对方联系不上怎么办？" name="1">
                            <div style="color:#606266; margin-left:20px">在这种情况下，建议您耐心等待几天。如果仍然无法联系到对方，您可以考虑进行<el-button type="text" @click="appeal_dialog_visible = true"><span style="font-size:13px">申诉</span></el-button>操作</div>
                        </el-collapse-item>
                        {% endif %}

                        {% endif %}
                    </el-collapse>
                </div>
            </div>
            <div style="width: 38vw; height: 100vh; position:fixed; left: 62vw; background-color: #F2F6FC;">
                <div style="background-color: white; height: calc(100% - 40px);box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1); margin: 20px; margin-left: 0;">
                    <div style="font-size: 16px; color:#409EFF; padding:20px; display:flex; align-items: center; justify-content: center;">
                        <i class="el-icon-user-solid"></i><span style="margin-left: 5px">谈判桌</span>
                        <el-divider direction="vertical"></el-divider>   
                        <div v-if="online === true" style="display:flex; align-items: center; justify-content: center;">
                            <span style="color: #606266; font-size: 13px"><i class="el-icon-chat-line-round"></i> 对方在线</span>
                        </div>
                        <div v-else>
                            <span style="color: #606266; font-size: 13px"><i class="el-icon-loading"></i> 对方不在线</span>
                        </div>
                    </div>                        
                    <template>
                        <div ref="chatBoxContainer" style="overflow-y:auto; scroll-margin-top: auto; margin-left: 20px; margin-right: 20px; padding: 20px; background-color: #FFFFFF; border: 1px solid #DCDFE6; border-radius:10px; height: calc(100% - 182px);">
                            <ul style="list-style: none">
                                <li v-for="msg in chat_msgs">
                                    <div v-if="msg.username === '{{usr.name}}'" style="display:flex; align-items:flex-start; justify-content: right;">
                                        <div class="chat-msg" v-text="msg.msg"></div>
                                        <div style="padding-top:10px"><el-avatar shape="square" :size="30":src="circleUrl"></el-avatar></div>
                                    </div>
                                    <div v-else style="display:flex; align-items:flex-start; justify-content: left;">
                                        <div style="padding-top:10px"><el-avatar shape="square" :size="30":src="circleUrl"></el-avatar></div>
                                        <div class="chat-msg" v-text="msg.msg"></div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </template>
                    <div style="padding-left: 20px; padding-right:20px; height: 80px; display:flex; align-items: center;">
                        <div style="width: calc(100% - 185px)">
                            <el-input v-model="chat_text" placeholder="请输入聊天内容" id="submitChatKey"></el-input>
                        </div>
                        <div style="width: 185px; display:flex; justify-content: right;">
                            <el-tooltip class="item" effect="dark" content="发送信息" placement="top-end">
                                <el-button type="primary" style="border-radius: 10px 0px 0px 10px;" id="submitChatBtn"><i class="el-icon-s-promotion"></i></el-button>
                            </el-tooltip>
                            {% with "cooperation."|addstr:cooperation.id as room %}
                            <el-tooltip class="item" effect="dark" content="在线文件传输" placement="top-end">
                                <a href="{% url 'help:transmit' room %}" target="_blank"><el-button type="primary" style="border:1px solid white; border-top-color:#409EFF; border-bottom-color: #409EFF; border-radius: 0;"><i class="el-icon-paperclip"></i></el-button></a>
                            </el-tooltip>
                            {% endwith %}
                            {% with "cooperation."|addstr:cooperation.id as room %}
                            <el-tooltip class="item" effect="dark" content="远程桌面共享 & 语音" placement="top-end">
                                <a href="{% url 'help:share' room %}" target="_blank"><el-button type="primary" style="border-radius: 0 10px 10px 0"><i class="el-icon-video-camera-solid"></i></el-button></a>
                            </el-tooltip>
                            {% endwith %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>

    <script src="https://unpkg.com/vue@2/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        const username = "{{usr.name}}"
        const client_name = "{{cooperation.follow.request.publisher.name}}"
        const server_name = "{{cooperation.follow.user.name}}"

        new Vue({

            el: '#app',
            data: function() {
                return {
                    circleUrl: "https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png",

                    active_step: parseInt("{{cooperation.active}}"),
                    request_document: `{{cooperation.request_document}}`,
                    document_visible: false,
                    html_document: '',
                    finish_date: "{{cooperation.predict_finish_date}}",
                    step2_confirm_visible: false,
                    step3_confirm_visible: false,
                    acceptance_date: "{{cooperation.acceptance_date}}",

                    // 关于聊天
                    chat_text: '',
                    chat_msgs: [],
                    online: false,

                    // 关于支付
                    pay_method: 'alipay',
                    pay_immediate_html: '立即支付',

                    // 取消合作
                    cancel_confirm_visible: false,

                    // 关于评价
                    rate: 0,
                    review:'',
                    submit_feedback_server: '提交评价',
                    submit_feedback_client: '提交评价',

                    // 申诉页面
                    appeal_dialog_visible: false,
                    appeal_form_model: {
                        reason: '',
                        mobile: '',
                        result: '',
                    },
                    appeal_form_rules: {
                        mobile: [
                            { required: true, message: "请输入电话号码", trigger: "blur" },
                            { min: 11, max: 11, message: "电话号码必须是11位", trigger: "change" }
                        ],
                        reason: [
                            { required: true, message: "请输入申诉原因", trigger: "blur" },
                        ],
                        result: [
                            { required: true, message: "请输入期望申诉结果", trigger: "blur" },
                        ],
                    },

                    // 关于支付
                    pay_url: '',
                    let_me_pay: '我要付款'
                }
            },

            mounted() {
                var self = this
                var websocket = new WebSocket("ws://" + window.location.hostname + ":8001")
                websocket.onopen = function() {
                    document.getElementById('submitChatBtn').onclick = () => {
                        var txt = self.chat_text
                        if (txt) {
                            websocket.send(txt)
                            self.chat_text = ''
                        }
                    }
                    document.getElementById('submitChatKey').addEventListener('keyup', function(event) {
                        if (event.key === 'Enter') {
                            var txt = self.chat_text
                            if (txt) {
                                websocket.send(txt)
                                self.chat_text = ''
                            }
                        }
                    })
                    var meta = {
                        'cooperation_id': "{{cooperation.id}}",
                        'username': "{{usr.name}}",
                    }
                    meta = JSON.stringify(meta)
                    websocket.send(meta)
                }
                websocket.onmessage = function(e) {
                    var msg = JSON.parse(e.data).data
                    if (msg.login === false && msg.logout === false) {
                        self.chat_msgs.push(msg)
                    } else if (msg.online === true) {
                        self.online = true;
                    } else if (msg.login === true && msg.username !== "{{usr.name}}") {
                        // 处理login事件
                        self.online = true;
                    } else if (msg.logout === true && msg.username !== "{{usr.name}}") {
                        // 处理logout事件
                        self.online = false;
                    }
                }

                /* 从服务器获取之前的聊天记录 */
                const data = {
                    cooperation_id: "{{cooperation.id}}"
                }
                const headers = {
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
                axios.post('/help/get/chat_msgs/', data, { headers })
                .then(response => {
                    if (response.data.chat_msgs) {
                        response.data.chat_msgs.forEach(function(msg) {
                            self.chat_msgs.push({
                                'username': msg.username,
                                'msg': msg.msg,
                                'login': false,
                                'logout': false,
                            })
                        })
                    }
                })
            },

            updated() {
                this.scrollToBottom();
            },

            methods: {
                scrollToBottom() {
                    const container = this.$refs.chatBoxContainer;
                    container.scrollTop = container.scrollHeight;
                },

                previewDocument: function() {
                    const data = {
                        document: this.request_document,
                    }
                    const headers = {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                    axios.post('/help/convert_md_to_html/', data, { headers })
                    .then(response => {
                        if (response.data.message) {
                            this.$message.error(response.data.message)
                        }
                        else if (response.data.success) {
                            this.document_visible = true
                            this.html_document = response.data.html_document
                        }
                    })
                },

                requestDocumentSubmit: function() {
                    const data = {
                        request_document: this.request_document,
                        cooperation_id: "{{cooperation.id}}",
                    }
                    const headers = {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                    axios.post('/help/submit/request_document/', data, { headers })
                    .then(response => {
                        if (response.data.message) {
                            this.$message.error(response.data.message)
                        }
                        else if (response.data.success) {
                            this.$message.success('提交成功，请主动通知对方验收')
                        }
                    })
                },

                entryNextSubmit: function() {
                    const data = {
                        active_step: this.active_step,
                        cooperation_id: "{{cooperation.id}}",
                    }
                    const headers = {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                    axios.post('/help/submit/entry_next_step/', data, { headers })
                    .then(response => {
                        if (response.data.message) {
                            this.$message.error(response.data.message)
                        }
                        else if (response.data.success) {
                            this.$message.success('进入合作的下一环节')
                            location.reload()
                        }
                    })
                },

                finishDateSubmit: function() {
                    const data = {
                        finish_date: this.finish_date,
                        cooperation_id: "{{cooperation.id}}",
                    }
                    const headers = {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                    axios.post('/help/submit/finish_date/', data, { headers })
                    .then(response => {
                        if (response.data.message) {
                            this.$message.error(response.data.message)
                        }
                        else if (response.data.success) {
                            if (response.data.fix) {
                                this.$message.success('已提交，对方同意后可直接生效')
                            }                     
                            else {
                                this.$message.success('成功提交预计完成日期')
                            }
                            location.reload()
                        }
                    })
                },

                acceptanceDateSubmit: function() {
                    const data = {
                        acceptance_date: this.acceptance_date,
                        cooperation_id: "{{cooperation.id}}"
                    }
                    const headers = {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                    axios.post('/help/submit/acceptance_date/', data, { headers })
                    .then(response => {
                        if (response.data.message) {
                            this.$message.error(response.data.message)
                        }
                        else if (response.data.success) {
                            if (response.data.fix) {
                                this.$message.success('已提交，对方同意后可直接生效')
                            }
                            else {
                                this.$message.success('成功提交验收日期')
                            }
                            location.reload()
                        }
                    })
                },

                fixSubmit: function(agree, fix_what) {
                    const data = {
                        agree: agree,
                        cooperation_id: "{{cooperation.id}}",
                    }
                    const headers = {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                    axios.post('/help/submit/' + fix_what + '/', data, { headers })
                    .then(response => {
                        if (response.data.message) {
                            this.$message.error(response.data.message)
                        }
                        else if (response.data.success) {
                            if (data.agree) {
                                this.$message.success('已同意对方的修改申请')
                            }                     
                            else {
                                this.$message.success('已拒绝对方的修改申请')
                            }
                            location.reload()
                        }
                    })
                },

                getDepositPayLink: function(pay_method) {
                    const data = {
                        pay_method: pay_method,
                        cooperation_id: "{{cooperation.id}}",
                        username: "{{usr.name}}"
                    }
                    const headers = {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                    this.pay_immediate_html = "立即支付 <i class='el-icon-loading'></i>"
                    axios.post('/help/get/deposit_pay_link/', data, { headers })
                    .then(response => {
                        this.pay_immediate_html = "立即支付"
                        if (response.data.message) {
                            this.$message.error(response.data.message)
                        }
                        else if (response.data.success) {
                            let url = response.data.url
                            window.location.assign(url)
                        }
                    })
                },

                getPayLink: function() {
                    const data = {
                        cooperation_id: "{{cooperation.id}}",
                        username: "{{usr.name}}"
                    }
                    const headers = {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                    this.let_me_pay = "我要付款 <i class='el-icon-loading'></i>"

                    axios.post('/help/get/pay_link/', data, { headers })
                    .then(response => {
                        this.let_me_pay = "我要付款"
                        if (response.data.message) {
                            this.$message.error(response.data.message)
                        }
                        else if (response.data.success) {
                            let url = response.data.url
                            window.location.assign(url)
                        }
                    })
                },

                submitCancelCooperation: function() {
                    const data = {
                        cooperation_id: "{{cooperation.id}}",
                        username: "{{usr.name}}"
                    }
                    const headers = {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                    axios.post('/help/submit/cancel_cooperation/', data, { headers })
                    .then(response => {
                        if (response.data.message) {
                            this.$message.error(response.data.message)
                        }
                        else if (response.data.success) {
                            this.$message.success('成功取消合作')
                            location.reload()
                        }
                    })
                },

                submitRateAndReview: function() {
                    const data = {
                        cooperation_id: "{{cooperation.id}}",
                        username: "{{usr.name}}",
                        rate: this.rate,
                        review: this.review,
                    }
                    const headers = {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }

                    this.submit_feedback_server = "提交评价 <i class='el-icon-loading'></i>"
                    this.submit_feedback_client = "提交评价 <i class='el-icon-loading'></i>"

                    axios.post('/help/submit/rate_and_review/', data, { headers })
                    .then(response => {
                        this.submit_feedback_server = "提交评价"
                        this.submit_feedback_client = "提交评价"
                        if (response.data.message) {
                            this.$message.error(response.data.message)
                        }
                        else if (response.data.success) {
                            this.$message.success('评论成功')
                            location.reload()
                        }
                    })
                },

                submitAppeal: function() {
                    this.$refs.appeal_form.validate(valid => {
                        if (valid) {
                            const data = {
                                cooperation_id: "{{cooperation.id}}",
                                username: "{{usr.name}}",
                                reason: this.appeal_form_model.reason,
                                mobile: this.appeal_form_model.mobile,
                                result: this.appeal_form_model.result,
                            }
                            const headers = {
                                'Content-Type': 'application/x-www-form-urlencoded'
                            }
                            axios.post('/help/submit/appeal/', data, { headers })
                            .then(response => {
                                if (response.data.message) {
                                    this.$message.error(response.data.message)
                                }
                                else if (response.data.success) {
                                    this.$message.success('申诉成功')
                                    location.reload()
                                }
                            })
                        }
                    })
                },

                cancelAppeal: function() {
                    const data = {
                        cooperation_id: "{{cooperation.id}}",
                        username: "{{usr.name}}",
                    }
                    const headers = {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                    axios.post('/help/remove/appeal/', data, { headers })
                    .then(response => {
                        if (response.data.message) {
                            this.$message.error(response.data.message)
                        }
                        else if (response.data.success) {
                            this.$message.success('已取消申诉')
                            location.reload()
                        }
                    })
                },
            },
        })
      </script>
</html>
