<!DOCTYPE html>

{% load static %}
{% load project_extras %}

<html lang="en-US">
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width"/>
        <title>{{request.title}}</title>
        <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
        <script src="https://unpkg.com/element-ui/lib/index.js"></script>
        <style>
            * {margin: 0; padding: 0}
            .request-item {
                box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
                margin: 20px;
            }

            .my-title {
                font-weight: bold; 
                font-size: 16px; 
                margin-bottom: 16px; 
                color:#303133
            }
        </style>
    </head>

    <body>
        <div id="app">
<<<<<<< HEAD
            {% include 'dialogs.html' %}
            {% include 'header.html' %}
=======
            <el-dialog width="80%" :visible.sync="browse_req_visible" title="我发布的需求">
                <el-row style="font-size: 14px; color: #606266; font-weight:bold;">
                    <el-col :span="18">标题</el-col>
                    <el-col :span="2">竞标人数</el-col>
                    <el-col :span="2">最低竞价</el-col>
                    <el-col :span="2">是否结束</el-col>
                </el-row>
                <el-divider></el-divider>
                {% for my_request in my_requests %}
                <el-row style="font-size: 13px; color: #606266;">
                    <el-col :span="18"><el-link href="{% url 'help:detail' my_request.id %}" target="_blank">{{my_request.title}}</el-link></el-col>
                    <el-col :span="2">{{my_request.num_bid}}</el-col>
                    <el-col :span="2">{{my_request.lowest_bid}}</el-col>
                    <el-col :span="2">{% if my_request.state == 0 %}否{% else %}是{% endif %}</el-col>
                </el-row>
                <el-divider></el-divider>
                {% endfor %}
            </el-dialog>

            <el-dialog width="80%" :visible.sync="browse_bid_visible" title="我发布的竞标">
                <el-row style="font-size: 14px; color: #606266; font-weight:bold;">
                    <el-col :span="18">标题</el-col>
                    <el-col :span="2">竞标人数</el-col>
                    <el-col :span="2">最低竞价</el-col>
                    <el-col :span="2">是否结束</el-col>
                </el-row>
                <el-divider></el-divider>
                {% for my_follow in my_follows %}
                <el-row style="font-size: 13px; color: #606266;">
                    <el-col :span="18"><el-link href="{% url 'help:detail' my_follow.request.id %}" target="_blank">{{my_follow.request.title}}</el-link></el-col>
                    <el-col :span="2">{{my_follow.request.num_bid}}</el-col>
                    <el-col :span="2">{{my_follow.request.lowest_bid}}</el-col>
                    <el-col :span="2">{% if my_follow.request.state == 0 %}否{% else %}是{% endif %}</el-col>
                </el-row>
                <el-divider></el-divider>
                {% endfor %}
            </el-dialog>

            <el-dialog width="50%" :visible.sync="cooperation_visible" title="联系对方">
                {% if rqst.publisher.name == usr.name %}
                <span>联系电话：{{follows.0.user.tel}}</span>
                {% elif follows.0.user.name == usr.name %}
                <span>联系电话：{{rqst.publisher.tel}}</span>
                {% endif %}
            </el-dialog>

            <el-dialog width="80%" :visible.sync="edit_visible" title="编辑个人资料">
                <el-form ref="editForm" :model="editForm" :rules="editRules" label-width="100px" class="ruleForm">
                    <el-form-item label="手机号码" prop="tel">
                        <el-input v-model="editForm.tel" placeholder="请输入 11 位手机号码" maxlength="11" show-word-limit></el-input>
                    </el-form-item>
                    <el-form-item label="个人简介" prop="introduction">
                        <el-input type="textarea" :autosize="{minRows: 2, maxRows: 5}" placeholder="请输入个人简介" v-model="editForm.introduction" maxlength="100" show-word-limit></el-input>
                    </el-form-item>
                    <el-form-item>
                        <el-button type="primary" @click="editSubmit">更新</el-button>
                        <el-button @click="edit_visible = false">取消</el-button>
                    </el-form-item>
                </el-form>
            </el-dialog>

            <el-dialog width="50%" :visible.sync="bid_visible" title="参与竞标">
                <el-form ref="bidForm" :model="bidForm" :rules="bidRules" label-width="200px" class="ruleForm">
                    <el-form-item label="竞标价" prop="bid">
                        <el-input placeholder="请输入竞标价" v-model="bidForm.bid" type="number" :min="0"></el-input>
                    </el-form-item>
                    <el-form-item label="有新的竞标时是否通知">
                        <el-switch
                            v-model="bidForm.notify_new_bids"
                            active-text="通知"
                            inactive-text="不通知">
                        </el-switch>
                    </el-form-item> 
                    <el-form-item>
                        <el-button type="primary" @click="bidSubmit">提交</el-button>
                        <el-button @click="bid_visible = false">取消</el-button>
                    </el-form-item>
                </el-form>
            </el-dialog>

            <el-dialog width="80%" :visible.sync="form_visible" title="发布需求">
                <el-form ref="ruleForm" :model="ruleForm" :rules="rules" label-width="100px" class="ruleForm">
                    <el-form-item label="选择领域" prop="field">
                        <el-radio-group v-model="ruleForm.field">
                            {% for field in all_fields %}
                            <el-radio label="{{field.1}}"></el-radio>
                            {% endfor %}
                        </el-radio-group>
                    </el-form-item>
                    <el-form-item label="选择性质" prop="type">
                        <el-radio-group v-model="ruleForm.type">
                            {% for rtype in all_request_type %}
                            <el-radio label="{{rtype.1}}"></el-radio>
                            {% endfor %}
                        </el-radio-group>
                    </el-form-item>
                    <el-form-item label="标题" prop="title">
                        <el-input v-model="ruleForm.title" placeholder="请输入标题" maxlength="20" show-word-limit></el-input>
                    </el-form-item>
                    <el-form-item label="详细需求" prop="detail">
                        <el-input type="textarea" :autosize="{minRows: 2, maxRows: 5}" placeholder="请输入详细需求，建议分条列出" v-model="ruleForm.detail" maxlength="200" show-word-limit></el-input>
                    </el-form-item>
                    <el-form-item>
                        <el-button type="primary" @click="formSubmit">立即发布</el-button>
                        <el-button @click="form_visible = false">取消</el-button>
                    </el-form-item>
                </el-form>
            </el-dialog>

            <el-dialog :visible.sync="signup_visible" title="新用户注册">
                <template>
                    <el-input v-model="signup_username" placeholder="用户名" maxlength="20" show-word-limit> </el-input>
                    <el-input v-model="signup_password" placeholder="密码" show-password maxlength="20" show-word-limit> </el-input>
                    <el-input v-model="signup_confirm" placeholder="确认密码" show-password maxlength="20" show-word-limit></el-input>
                    <span slot="footer" class="dialog-footer">
                        <el-button @click="signup_visible = false">取消</el-button>
                        <el-button type="primary" @click="signupSubmit">确定</el-button>
                    </span>
                </template>
            </el-dialog>
                
            <el-dialog :visible.sync="login_visible" title="用户登录">
                <template>
                    <el-input v-model="login_username" placeholder="用户名" maxlength="20" show-word-limit> </el-input>
                    <el-input v-model="login_password" placeholder="密码" show-password maxlength="20" show-word-limit> </el-input>
                    <span slot="footer" class="dialog-footer">
                        <el-button @click="login_visible = false">取消</el-button>
                        <el-button type="primary" @click="loginSubmit">登录</el-button>
                    </span>
                </template>
            </el-dialog>

            <!--Header-->
            <el-container style="border: 1px solid #eeeeee; box-shadow: 0 0 10px #eeeeee">
                <el-row style="width: 100%;">
                    <el-col :span="2" >
                        <el-image style="width: 200px; height:auto;" src="{% static 'help/image/logo.png' %}"></el-image>
                    </el-col>
                    <el-col :span="22" >
                        <el-header style="display:flex; align-items:center; justify-content: flex-end; font-size: 12px;">
                            {% if username is None %}
                            <el-button type="text" @click="signup_visible = true">注册</el-button>
                            <el-button type="text" @click="login_visible = true">登录</el-button>
                            {% else %}
                            <el-dropdown>
                                <div style="display: flex; align-items: center;" class="el-dropdown-link">
                                    <el-avatar :size="small" :src="circleUrl"></el-avatar>
                                    <span style="margin-left: 10px">{{username}}</span>
                                    <i class="el-icon-arrow-down el-icon--right"></i>
                                </div>
                                <el-dropdown-menu slot="dropdown">
                                    <el-dropdown-item><el-button type="text" @click="browse_req_visible = true">我的需求</el-button></el-button></el-dropdown-item>
                                    <el-dropdown-item><el-button type="text" @click="browse_bid_visible = true">我的竞标</el-button></el-button></el-dropdown-item>
                                    <el-dropdown-item><el-button type="text" @click="edit_visible = true">个人资料</el-button></el-dropdown-item>
                                    <el-dropdown-item><el-button type="text" @click="exitSubmit">退出</el-button></el-dropdown-item>
                                </el-dropdown-menu>
                            </el-dropdown>
                            {% endif %}
                            <template>
                                <el-button style="margin-left: 20px" @click="form_visible = true">发布需求</el-button>
                            </template>
                        </el-header>
                    </el-col>
                </el-row>
            </el-container>

>>>>>>> parent of d18f5ce (u)
            <el-container>
                <el-main>
                    <el-row :gutter="20">
                        <el-col :span="12">
                            <div style="background-color:blanchedalmon;">
                                {% for follow in follows %}
                                <div style="box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1); margin-bottom: 20px; padding: 20px;">
                                    <el-row type="flex" align="middle">
                                        <el-col :span="16">
                                            <div style="display: flex; align-items:center;">
                                                <el-avatar :size="small" :src="circleUrl"></el-avatar>
                                                <span style="margin-left: 10px">{{follow.user.name}}</span>
                                            </div>
                                        </el-col>
                                        <el-col :span="8">
                                            <div style="text-align:right">
                                                <span style="color: rgb(31, 163, 31);">竞价 {{follow.bid_price}} 元</span>
                                            </div>
                                        </el-col>
                                    </el-row>
                                    <div style="margin-top: 20px; margin-bottom: 20px; font-size: 12px;">
                                        <el-row type="flex" align="middle" :gutter="20">
                                            <el-col :span="16">
                                                <span>竞标次数 {{follow.user.bid_times}}</span>
                                                <el-divider direction="vertical"></el-divider>
                                                <span>中标次数 {{follow.user.win_times}}</span>
                                                <el-divider direction="vertical"></el-divider>
                                                <span>好评次数 {{follow.user.positive_times}}</span>
                                            </el-col>
                                            {% if username == rqst.publisher.name %}
                                            <el-col :span="8">
                                                <div style="text-align:right;">
                                                    {% if rqst.state == 1 %}
                                                    {% if follow.state == 1 %}
                                                    <el-button @click="cooperation_visible = true">开始合作</el-button>
                                                    {% elif follow.state == 0 %}
                                                    <span>未中标</span>
                                                    {% endif %}
                                                    {% elif rqst.state == 0 %}
                                                    <el-button @click="cooSubmit({{follow.id}})">确认合作</el-button>
                                                    {% endif %}
                                                </div>
                                            </el-col>
                                            {% elif rqst.state == 1 %}
                                            <el-col :span="8">
                                                <div style="text-align:right;">
                                                    {% if follow.state == 1 %}
                                                    <span style="color:rgb(31, 163, 31)">中标</span>
                                                    {% elif follow.state == 0 %}
                                                    <span>未中标</span>
                                                    {% endif %}
                                                </div>
                                            </el-col>
                                            {% endif %}
                                        </el-row>
                                    </div>
                                    <div>
                                        <el-collapse>
                                            <el-collapse-item title="个人简介">
                                              <div>{{follow.user.introduction}}</div>
                                            </el-collapse-item>
                                        </el-collapse>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </el-col>
                        {% if follows.count == 0 %}
                        <el-col :span="12" :offset="6">
                        {% else %}
                        <el-col :span="6">
                        {% endif %}
                            <div style="box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);">
                                <div style="padding: 20px;">
                                    <el-row>
                                        <el-col :span="20">
                                            <span style="font-size: 20px;">{{rqst.title}}</span>
                                        </el-col>
                                        <el-col :span="4">
                                            <div style="text-align:right;">
                                                {% if rqst.state == 0 %}
                                                <span style="color: rgb(31, 163, 31)">招标中</span>
                                                {% else %}
                                                <span style="color: rgb(189, 26, 26)">招标结束</span>
                                                {% endif %}
                                            </div>
                                        </el-col>
                                    </el-row>
                                    <div style="margin-top: 20px;">
                                        {% if rqst.publisher.name != username %}
                                        <el-button type="primary" @click="bid_visible = true">参与竞标</el-button>
                                        {% endif %}
                                    </div>
                                </div>

                                <div style="padding: 20px;">
                                    <el-collapse v-model="activeNames" @change="handleChange">
                                        <el-collapse-item title="发布者信息" name="1">
                                            <div style="padding: 20px;">
                                                <div style="display: flex; align-items:center;">
                                                    <el-avatar :size="small" :src="circleUrl"></el-avatar>
                                                    <span style="margin-left: 10px; margin-right: 10px;">{{rqst.publisher.name}}</span>
                                                    <el-divider direction="vertical"></el-divider>
                                                    <span style="font-size: 12px; margin-left: 10px;">共发布 {{rqst.publisher.pub_times}} 个需求</span> 
                                                </div>
                                                <div style="margin-top: 20px;">
                                                    <div style="font-size: 13px">个人简介：{{rqst.publisher.introduction}}</div>
                                                </div>
                                            </div>
                                        </el-collapse-item>
                                        <el-collapse-item title="需求描述" name="2">
                                            <div style="padding: 20px; font-size: 13px">
                                                <span>{{rqst.content}}</span>
                                            </div>
                                        </el-collapse-item>
                                    </el-collapse>
                                </div>
                            </div>
                        </el-col>
                    </el-row>
                </el-main>
            </el-container>
        </div>
    </body>

    <script src="https://unpkg.com/vue@2/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        import { headerData, headerAPI, circleUrl } from '../../static/help/javascript/help/header.js'

        new Vue({
            el: '#app',
            data: function() {
                return {
                    // 杂项
                    circleUrl: circleUrl,

                    headerData: headerData,    

                    pageData: {
                        bid: {
                            visible: false,
                            bid: '',
                            notify_new_bids: true,
                            rules: {
                                bid: [
                                    { required: true, message: '请输入竞标价', trigger: 'blur' },
                                ],
                            },
                        },
                    },
                }
            },

            methods: {
                // header需要的一些API
                signupSubmit() { headerAPI.signupSubmit.call(this); },
                loginSubmit() { headerAPI.loginSubmit.call(this); },
                exitSubmit() { headerAPI.exitSubmit.call(this); },
                requestSubmit() { headerAPI.requestSubmit.call(this); },
                editSubmit() { headerAPI.editSubmit.call(this); },

                bidSubmit() {
                    const data = {
                        bid: this.pageData.bid.bid,
                        notify_new_bids: this.pageData.bid.notify_new_bids,
                    }
                    const headers = {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                    var request_id = "{{rqst.id}}"
                    this.$refs['bidForm'].validate((valid) => {
                        if (valid) {
                            axios.post('/help/bidding/' + request_id + "/", data, { headers })
                            .then(response => {
                                if (response.data.message) {
                                    this.$message.error(response.data.message)
                                }
                                else if (response.data.success) {
                                    this.$message({
                                        message: '竞标成功',
                                        type: 'success',
                                    })
                                    this.pageData.bid.visible = false;
                                }
                            })
                        }
                    })
                },

                cooSubmit(id) {
                    const data = {
                        id: id,
                    }
                    const headers = {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                    axios.post('/help/cooperation/', data, { headers })
                    .then(response => {
                        if (response.data.message) {
                            this.$message.error(response.data.message)
                        }
                        else if (response.data.success) {
                            this.$message({
                                message: '合作关系建立成功',
                                type: 'success',
                            })
                            location.reload()
                        }
                    })
                }
            }
        })
      </script>
</html>
