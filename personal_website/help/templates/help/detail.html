<!DOCTYPE html>

{% load static %}
{% load project_extras %}

<html lang="en-US">
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width"/>
        <title>{{rqst.title}}</title>
        <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
        <script src="https://unpkg.com/element-ui/lib/index.js"></script>
        <style>
            * {margin: 0; padding: 0}
            .request-item {
                box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
                margin: 20px;
            }

            .my-title {
                font-weight: bold; 
                font-size: 16px; 
                margin-bottom: 16px; 
                color:#303133
            }

            body {
                background-color: #F2F6FC;
            }
        </style>
    </head>

    <body>
        <div id="app">
            <el-dialog width="80%" :visible.sync="browse_req_visible" title="我发布的需求">
                <el-row style="font-size: 14px; color: #606266; font-weight:bold;">
                    <el-col :span="18">标题</el-col>
                    <el-col :span="2">竞标人数</el-col>
                    <el-col :span="2">最低竞价</el-col>
                    <el-col :span="2">是否结束</el-col>
                </el-row>
                <el-divider></el-divider>
                {% for my_request in my_requests %}
                <el-row style="font-size: 13px; color: #606266;">
                    <el-col :span="18"><el-link href="{% url 'help:detail' my_request.id %}" target="_blank">{{my_request.title}}</el-link></el-col>
                    <el-col :span="2">{{my_request.num_bid}}</el-col>
                    <el-col :span="2">{{my_request.lowest_bid}}</el-col>
                    <el-col :span="2">{% if my_request.state == 0 %}否{% else %}是{% endif %}</el-col>
                </el-row>
                <el-divider></el-divider>
                {% endfor %}
            </el-dialog>

            <el-dialog width="80%" :visible.sync="browse_bid_visible" title="我发布的竞标">
                <el-row style="font-size: 14px; color: #606266; font-weight:bold;">
                    <el-col :span="18">标题</el-col>
                    <el-col :span="2">竞标人数</el-col>
                    <el-col :span="2">最低竞价</el-col>
                    <el-col :span="2">是否结束</el-col>
                </el-row>
                <el-divider></el-divider>
                {% for my_follow in my_follows %}
                <el-row style="font-size: 13px; color: #606266;">
                    <el-col :span="18"><el-link href="{% url 'help:detail' my_follow.request.id %}" target="_blank">{{my_follow.request.title}}</el-link></el-col>
                    <el-col :span="2">{{my_follow.request.num_bid}}</el-col>
                    <el-col :span="2">{{my_follow.request.lowest_bid}}</el-col>
                    <el-col :span="2">{% if my_follow.request.state == 0 %}否{% else %}是{% endif %}</el-col>
                </el-row>
                <el-divider></el-divider>
                {% endfor %}
            </el-dialog>

            <el-dialog width="50%" :visible.sync="cooperation_visible" title="联系对方">
                {% if rqst.publisher.name == usr.name %}
                <span>联系电话：{{follows.0.user.tel}}</span>
                {% elif follows.0.user.name == usr.name %}
                <span>联系电话：{{rqst.publisher.tel}}</span>
                {% endif %}
            </el-dialog>

            <el-dialog width="80%" :visible.sync="edit_visible" title="编辑个人资料">
                <el-form ref="editForm" :model="editForm" :rules="editRules" label-width="100px" class="ruleForm">
                    <el-form-item label="手机号码" prop="tel">
                        <el-input v-model="editForm.tel" placeholder="请输入 11 位手机号码" maxlength="11" show-word-limit></el-input>
                    </el-form-item>
                    <el-form-item label="个人简介" prop="introduction">
                        <el-input type="textarea" :autosize="{minRows: 2, maxRows: 5}" placeholder="请输入个人简介" v-model="editForm.introduction" maxlength="100" show-word-limit></el-input>
                    </el-form-item>
                    <el-form-item>
                        <el-button type="primary" @click="editSubmit">更新</el-button>
                        <el-button @click="edit_visible = false">取消</el-button>
                    </el-form-item>
                </el-form>
            </el-dialog>

            <el-dialog width="80%" :visible.sync="bid_visible" title="参与竞标">
                <el-form ref="bidForm" :model="bidForm" :rules="bidRules" class="ruleForm">
                    <el-form-item label="竞标价" prop="bid">
                        <el-input placeholder="请输入竞标价" v-model="bidForm.bid" type="number" :min="0"></el-input>
                    </el-form-item>
                    <el-form-item label="选择流程" prop="procedure_id">
                        <el-select v-model="bidForm.procedure_id" placeholder="请选择">
                            {% for procedure in procedures %}
                            <el-option label="{{procedure.name}}" value="{{procedure.id}}"></el-option>
                            {% endfor %}
                        </el-select>
                    </el-form-item>
                    <el-form-item>
                        <el-button type="primary" @click="bidSubmit">提交</el-button>
                        <el-button @click="bid_visible = false">取消</el-button>
                    </el-form-item>
                </el-form>
            </el-dialog>

            <el-dialog width="80%" :visible.sync="form_visible" title="发布需求">
                <el-form ref="ruleForm" :model="ruleForm" :rules="rules" label-width="100px" class="ruleForm">
                    <el-form-item label="选择领域" prop="field">
                        <el-radio-group v-model="ruleForm.field">
                            {% for field in all_fields %}
                            <el-radio label="{{field.1}}"></el-radio>
                            {% endfor %}
                        </el-radio-group>
                    </el-form-item>
                    <el-form-item label="选择性质" prop="type">
                        <el-radio-group v-model="ruleForm.type">
                            {% for rtype in all_request_type %}
                            <el-radio label="{{rtype.1}}"></el-radio>
                            {% endfor %}
                        </el-radio-group>
                    </el-form-item>
                    <el-form-item label="标题" prop="title">
                        <el-input v-model="ruleForm.title" placeholder="请输入标题" maxlength="20" show-word-limit></el-input>
                    </el-form-item>
                    <el-form-item label="详细需求" prop="detail">
                        <el-input type="textarea" :autosize="{minRows: 2, maxRows: 5}" placeholder="请输入详细需求，建议分条列出" v-model="ruleForm.detail" maxlength="200" show-word-limit></el-input>
                    </el-form-item>
                    <el-form-item>
                        <el-button type="primary" @click="formSubmit">立即发布</el-button>
                        <el-button @click="form_visible = false">取消</el-button>
                    </el-form-item>
                </el-form>
            </el-dialog>

            <el-dialog :visible.sync="signup_visible" title="新用户注册">
                <template>
                    <el-input v-model="signup_username" placeholder="用户名" maxlength="20" show-word-limit> </el-input>
                    <el-input v-model="signup_password" placeholder="密码" show-password maxlength="20" show-word-limit> </el-input>
                    <el-input v-model="signup_confirm" placeholder="确认密码" show-password maxlength="20" show-word-limit></el-input>
                    <span slot="footer" class="dialog-footer">
                        <el-button @click="signup_visible = false">取消</el-button>
                        <el-button type="primary" @click="signupSubmit">确定</el-button>
                    </span>
                </template>
            </el-dialog>
                
            <el-dialog :visible.sync="login_visible" title="用户登录">
                <template>
                    <el-input v-model="login_username" placeholder="用户名" maxlength="20" show-word-limit> </el-input>
                    <el-input v-model="login_password" placeholder="密码" show-password maxlength="20" show-word-limit> </el-input>
                    <span slot="footer" class="dialog-footer">
                        <el-button @click="login_visible = false">取消</el-button>
                        <el-button type="primary" @click="loginSubmit">登录</el-button>
                    </span>
                </template>
            </el-dialog>

            <!--Header-->
            <el-container style="border: 1px solid #eeeeee; box-shadow: 0 0 10px #eeeeee; background-color: white;">
                <el-row style="width: 100%;">
                    <el-col :span="2" >
                        <el-image style="width: 200px; height:auto;" src="{% static 'help/image/logo.png' %}"></el-image>
                    </el-col>
                    <el-col :span="22" >
                        <el-header style="display:flex; align-items:center; justify-content: flex-end; font-size: 12px;">
                            {% if username is None %}
                            <el-button type="text" @click="signup_visible = true">注册</el-button>
                            <el-button type="text" @click="login_visible = true">登录</el-button>
                            {% else %}
                            <el-dropdown>
                                <div style="display: flex; align-items: center;" class="el-dropdown-link">
                                    <el-avatar :size="small" :src="circleUrl"></el-avatar>
                                    <span style="margin-left: 10px">{{username}}</span>
                                    <i class="el-icon-arrow-down el-icon--right"></i>
                                </div>
                                <el-dropdown-menu slot="dropdown">
                                    <el-dropdown-item><el-button type="text" @click="browse_req_visible = true">我的需求</el-button></el-button></el-dropdown-item>
                                    <el-dropdown-item><el-button type="text" @click="browse_bid_visible = true">我的竞标</el-button></el-button></el-dropdown-item>
                                    <el-dropdown-item><el-button type="text" @click="edit_visible = true">个人资料</el-button></el-dropdown-item>
                                    <el-dropdown-item><el-button type="text" @click="exitSubmit">退出</el-button></el-dropdown-item>
                                </el-dropdown-menu>
                            </el-dropdown>
                            {% endif %}
                            <template>
                                <el-button style="margin-left: 20px" @click="form_visible = true">发布需求</el-button>
                            </template>
                        </el-header>
                    </el-col>
                </el-row>
            </el-container>

            <el-container>
                <el-main style="background-color: #F2F6FC;">
                    <el-row :gutter="20" type="flex" justify="center">
                        {% if follows.count != 0 %}
                        <el-col :span="12">
                            <div>
                                {% for follow in follows %}
                                <div style="box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1); margin-bottom: 20px; padding: 20px; background-color: white;">
                                    <el-row type="flex" align="middle">
                                        <el-col :span="16">
                                            <div style="display: flex; align-items:center;">
                                                <el-avatar :size="small" :src="circleUrl"></el-avatar>
                                                <span style="margin-left: 10px">{{follow.user.name}}</span>
                                            </div>
                                        </el-col>
                                        <el-col :span="8">
                                            <div style="text-align:right">
                                                <span style="color: rgb(31, 163, 31);">竞价 {{follow.bid_price}} 元</span>
                                            </div>
                                        </el-col>
                                    </el-row>
                                    <div style="margin-top: 20px; margin-bottom: 20px; font-size: 12px;">
                                        <el-row type="flex" align="middle" :gutter="20">
                                            <el-col :span="16">
                                                <span>中标次数 {{follow.user.win_times}}</span>
                                                <el-divider direction="vertical"></el-divider>
                                                <span>竞方好评率 {{follow.rate}}%</span>
                                            </el-col>
                                            {% if username == rqst.publisher.name %}
                                            <el-col :span="8">
                                                <div style="text-align:right;">
                                                    {% if rqst.state == 1 %}
                                                    {% if follow.state == 1 %}
                                                    <el-button type="primary" @click="redirectToCooperation">开始合作</el-button>
                                                    {% elif follow.state == 0 %}
                                                    <span>未中标</span>
                                                    {% endif %}
                                                    {% elif rqst.state == 0 %}
                                                    <el-button @click="cooSubmit({{follow.id}})">确认合作</el-button>
                                                    {% endif %}
                                                </div>
                                            </el-col>
                                            {% elif rqst.state == 1 %}
                                            <el-col :span="8">
                                                <div style="text-align:right;">
                                                    {% if follow.state == 1 %}
                                                    {% if follow.user == usr %}
                                                    <el-button type="primary" @click="redirectToCooperation">开始合作</el-button>
                                                    {% else %}
                                                    <span style="color:rgb(31, 163, 31)">中标</span>
                                                    {% endif %}
                                                    {% elif follow.state == 0 %}
                                                    <span>未中标</span>
                                                    {% endif %}
                                                </div>
                                            </el-col>
                                            {% endif %}
                                        </el-row>
                                    </div>
                                    <div>
                                        <el-collapse>
                                            <el-collapse-item title="竞方简介">
                                                <div style="padding-left:20px; padding-right:20px;color:#606266">{{follow.user.introduction}}</div>
                                            </el-collapse-item>
                                            <el-collapse-item title="竞方评价">
                                                {% for feedback in follow.feedbacks %}
                                                <div style="padding-bottom:20px; padding-left:20px; padding-right:20px">
                                                    <div style="display:flex;align-items: center; padding-top:10px; padding-bottom:10px;">
                                                        <el-avatar :size="30" shape="square" :src="circleUrl"></el-avatar>
                                                        <div style="margin-left: 10px; color:#606266">{{feedback.coop.follow.request.publisher.name}}</div>
                                                        <el-divider direction="vertical"></el-divider>
                                                        <div style="font-size: 13px; color:#909399">{{feedback.date|date:"Y-m-d"}}</div>
                                                    </div>
                                                    <div style="color:#606266; padding-left:40px">
                                                        {{feedback.review}}
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </el-collapse-item>
                                            <el-collapse-item title="服务流程">
                                                <div style="height: 400px; padding: 20px;">
                                                    <el-steps direction="vertical">
                                                        {% for step in follow.procedure.procedurestep_set.all %}
                                                        <el-step status="process" title="{% if step.pay > 0 %}{{step.title}}（支付{{step.pay}}%）{% else %}{{step.title}}{% endif %}" description="{{step.discription}}"></el-step>
                                                        {% endfor %}
                                                      </el-steps>
                                                </div>
                                            </el-collapse-item>
                                        </el-collapse>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </el-col>
                        {% endif %}
                        {% if follows.count == 0 %}
                        <el-col :xs="22" :sm="20" :md="18" :lg="16" :xl="14">
                        {% else %}
                        <el-col :span="12">
                        {% endif %}
                            <div style="box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1); background-color: white;">
                                <div style="padding: 20px;">
                                    <el-row>
                                        <el-col :span="20">
                                            <span style="font-size: 20px;">{{rqst.title}}</span>
                                        </el-col>
                                        <el-col :span="4">
                                            <div style="text-align:right;">
                                                {% if rqst.state == 0 %}
                                                <span style="color: rgb(31, 163, 31)">招标中</span>
                                                {% else %}
                                                <span style="color: rgb(189, 26, 26)">招标结束</span>
                                                {% endif %}
                                            </div>
                                        </el-col>
                                    </el-row>
                                    <div style="margin-top: 20px">
                                        {% if rqst.publisher.name != username and rqst.state == 0 %}
                                        <el-button type="primary" @click="bid_visible = true">参与竞标</el-button>
                                        {% endif %}
                                    </div>
                                </div>

                                <div style="padding:20px">
                                    <el-collapse>
                                        <el-collapse-item title="需方信息" name="1">
                                            <div style="padding: 20px;">
                                                <div style="display: flex; align-items:center; color:#606266">
                                                    <el-avatar shape="square" :size="30" :src="circleUrl"></el-avatar>
                                                    <span style="margin-left: 10px; margin-right: 10px;">{{rqst.publisher.name}}</span>
                                                    <el-divider direction="vertical"></el-divider>
                                                    <span style="font-size: 12px; margin-left: 10px;">共发布 {{rqst.publisher.pub_times}} 个需求</span> 
                                                </div>
                                                {% if rqst.publisher.introduction %}
                                                <div style="margin-top: 20px;">
                                                    <div style="font-size: 13px; color:#606266">个人简介：{{rqst.publisher.introduction}}</div>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </el-collapse-item>
                                        <el-collapse-item title="详细需求" name="2">
                                            <div style="padding: 20px; font-size: 13px; color:#606266">
                                                <span>{{rqst.content}}</span>
                                            </div>
                                        </el-collapse-item>
                                    </el-collapse>
                                </div>
                            </div>
                        </el-col>
                    </el-row>
                </el-main>
            </el-container>
        </div>
    </body>

    <script src="https://unpkg.com/vue@2/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        new Vue({
          el: '#app',
          data: function() {
            var user_tel = "{{usr.tel}}";
            var user_introduction = "{{usr.introduction}}";

            return {
                // 杂项
                circleUrl: "https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png",

                // 与注册相关
                'signup_visible': false,
                'signup_username': '',
                'signup_password': '',
                'signup_confirm': '',

                // 与登录相关
                'login_visible': false,
                'login_username': '',
                'login_password': '',

                // 与发布需求相关
                'form_visible': false,

                // 与竞标相关
                'bid_visible': false,

                // 与个人资料相关
                'edit_visible': false,
                'browse_req_visible': false,
                'browse_bid_visible': false,
                
                // 与合作相关
                'cooperation_visible': false,
                active_step: 0,

                ruleForm: {
                    field: '',
                    type: '',
                    title: '',
                    detail: '',
                },

                rules: {
                    field: [
                        { required: true, message: '请选择所属的领域', trigger: 'change' },
                    ],
                    type: [
                        { required: true, message: '请选择活动区域', trigger: 'blur' },
                    ],
                    title: [
                        { required: true, message: '请输入需求的标题', trigger: 'blur' },
                        { min: 8, max: 20, message: '长度在 8 到 20 个字符之间', trigger: 'blur' },
                    ],
                    detail: [
                        { required: true, message: '请输入详细需求', trigger: 'blur' },
                    ],
                },

                bidForm: {
                    bid: '',
                    procedure_id: '',
                },

                editForm: {
                    tel: user_tel,
                    introduction: user_introduction,
                },

                bidRules: {
                    bid: [
                        { required: true, message: '请输入竞标价', trigger: 'blur' },
                    ],
                    procedure_id: [
                        { required: true, message: '请选择流程，若无数据则请先登录', trigger: 'blur' }
                    ],
                },
                editRules: {
                    tel: [
                        { required: true, message: '请输入手机号码', trigger: 'blur' },
                        { min: 11, max: 11, message: '长度为 11 位', trigger: 'change' },
                    ],
                    introduction: [
                        { required: true, message: '请输入个人简介', trigger: 'blur' },
                        { min: 20, max: 100, message: '长度在 20 到 100 个字符之间', trigger: 'change' },
                    ],
                }
            }
          
          },

          methods: {
            signupSubmit() {
                const data = {
                    signup_username: this.signup_username,
                    signup_password: this.signup_password,
                    signup_confirm: this.signup_confirm,
                }
                const headers = {
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
                axios.post('/help/signup/', data, { headers })
                .then(response => {
                    // 处理返回后台的数据
                    if (response.data.message) {
                        this.$message.error(response.data.message)
                    }
                    else if (response.data.success) {
                        this.$message.success('注册成功')
                        this.signup_visible = false;
                        location.reload()
                    }
                })
                .catch(error => {
                    // 处理错误
                })
            },

            loginSubmit() {
                const data = {
                    login_username: this.login_username,
                    login_password: this.login_password,
                }
                const headers = {
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
                axios.post('/help/login/', data, { headers })
                .then(response => {
                    if (response.data.message) {
                        this.$message.error(response.data.message)
                    }
                    else if (response.data.success) {
                        this.login_visible = false;
                        location.reload()
                    }
                })                
                .catch(error => {
                    // 处理错误
                })
            },

            exitSubmit() {
                const data = {}
                const headers = {
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
                axios.post('/help/exit/', data, { headers })
                .then(response => {
                    location.reload()
                })
                .catch(error => {
                    // 处理错误
                })
            },

            formSubmit() {
                const data = {
                    field: this.ruleForm.field,
                    type: this.ruleForm.type,
                    title: this.ruleForm.title,
                    detail: this.ruleForm.detail,
                }
                const headers = {
                    'Content-Type': 'application/x-www-form-urlencoded'
                }

                this.$refs['ruleForm'].validate((valid) => {
                    if (valid) {
                        axios.post('/help/request_publish/', data, { headers })
                        .then(response => {
                            if (response.data.message) {
                                this.$message.error(response.data.message)
                            }
                            else if (response.data.success) {
                                this.$message({
                                    message: '发布成功，请在个人页面进行查看',
                                    type: 'success',
                                })
                                this.form_visible = false;
                            }
                        })
                    }
                })
            },

            bidSubmit() {
                const data = {
                    bid: this.bidForm.bid,
                    procedure_id: this.bidForm.procedure_id,
                }
                const headers = {
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
                var request_id = "{{rqst.id}}"
                this.$refs['bidForm'].validate((valid) => {
                    if (valid) {
                        axios.post('/help/bidding/' + request_id + "/", data, { headers })
                        .then(response => {
                            if (response.data.message) {
                                this.$message.error(response.data.message)
                            }
                            else if (response.data.success) {
                                this.$message({
                                    message: '竞标成功',
                                    type: 'success',
                                })
                                location.reload()
                            }
                        })
                    }
                })
            },

            editSubmit() {
                const data = {
                    tel: this.editForm.tel,
                    introduction: this.editForm.introduction,
                }
                const headers = {
                    'Content-Type': 'application/x-www-form-urlencoded'
                }

                this.$refs['editForm'].validate((valid) => {
                    if (valid) {
                        axios.post('/help/edit_information/', data, { headers })
                        .then(response => {
                            if (response.data.message) {
                                this.$message.error(response.data.message)
                            }
                            else if (response.data.success) {
                                this.$message({
                                    message: '个人资料修改成功',
                                    type: 'success',
                                })
                                this.edit_visible = false;
                            }
                        })
                    }
                })
            },

            cooSubmit(id) {
                const data = {
                    id: id,
                }
                const headers = {
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
                axios.post('/help/make_cooperation/', data, { headers })
                .then(response => {
                    if (response.data.message) {
                        this.$message.error(response.data.message)
                    }
                    else if (response.data.success) {
                        this.$message({
                            message: '合作关系建立成功',
                            type: 'success',
                        })
                        location.reload()
                    }
                })
            },

            redirectToCooperation() {
                var follow_id = '{{cooperation.id}}'
                window.location.href = '/help/cooperation/' + follow_id + '/'
            },
          }
        })
      </script>
</html>
