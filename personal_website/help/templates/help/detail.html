<!DOCTYPE html>

{% load static %}
{% load project_extras %}

<html lang="en-US">
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width"/>
        <title>{{request.title}}</title>
        <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
        <script src="https://unpkg.com/element-ui/lib/index.js"></script>
        <style>
            * {margin: 0; padding: 0}
            .request-item {
                box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
                margin: 20px;
            }

            .my-title {
                font-weight: bold; 
                font-size: 16px; 
                margin-bottom: 16px; 
                color:#303133
            }
        </style>
    </head>

    <body>
        <div id="app">
            {% include 'dialogs.html' %}
            {% include 'header.html' %}
            <el-container>
                <el-main>
                    <el-row :gutter="20" type="flex" justify="center">
                        {% if follows.count != 0 %}
                        <el-col :span="12">
                            <div style="background-color:blanchedalmon;">
                                {% for follow in follows %}
                                <div style="box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1); margin-bottom: 20px; padding: 20px;">
                                    <el-row type="flex" align="middle">
                                        <el-col :span="16">
                                            <div style="display: flex; align-items:center;">
                                                <el-avatar :size="small" :src="circleUrl"></el-avatar>
                                                <span style="margin-left: 10px">{{follow.user.name}}</span>
                                            </div>
                                        </el-col>
                                        <el-col :span="8">
                                            <div style="text-align:right">
                                                <span style="color: rgb(31, 163, 31);">竞价 {{follow.bid_price}} 元</span>
                                            </div>
                                        </el-col>
                                    </el-row>
                                    <div style="margin-top: 20px; margin-bottom: 20px; font-size: 12px;">
                                        <el-row type="flex" align="middle" :gutter="20">
                                            <el-col :span="16">
                                                <span>竞标次数 {{follow.user.bid_times}}</span>
                                                <el-divider direction="vertical"></el-divider>
                                                <span>中标次数 {{follow.user.win_times}}</span>
                                                <el-divider direction="vertical"></el-divider>
                                                <span>好评次数 {{follow.user.positive_times}}</span>
                                            </el-col>
                                            {% if username == rqst.publisher.name %}
                                            <el-col :span="8">
                                                <div style="text-align:right;">
                                                    {% if rqst.state == 1 %}
                                                    {% if follow.state == 1 %}
                                                    <el-button @click="cooperation_visible = true">开始合作</el-button>
                                                    {% elif follow.state == 0 %}
                                                    <span>未中标</span>
                                                    {% endif %}
                                                    {% elif rqst.state == 0 %}
                                                    <el-button @click="cooSubmit({{follow.id}})">确认合作</el-button>
                                                    {% endif %}
                                                </div>
                                            </el-col>
                                            {% elif rqst.state == 1 %}
                                            <el-col :span="8">
                                                <div style="text-align:right;">
                                                    {% if follow.state == 1 %}
                                                    <span style="color:rgb(31, 163, 31)">中标</span>
                                                    {% elif follow.state == 0 %}
                                                    <span>未中标</span>
                                                    {% endif %}
                                                </div>
                                            </el-col>
                                            {% endif %}
                                        </el-row>
                                    </div>
                                    <div>
                                        <el-collapse>
                                            <el-collapse-item title="个人简介">
                                              <div>{{follow.user.introduction}}</div>
                                            </el-collapse-item>
                                        </el-collapse>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </el-col>
                        {% endif %}
                        {% if follows.count == 0 %}
                        <el-col :xs="22" :sm="20" :md="18" :lg="16" :xl="14">
                        {% else %}
                        <el-col :span="12">
                        {% endif %}
                            <div style="box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);">
                                <div style="padding: 20px;">
                                    <el-row>
                                        <el-col :span="20">
                                            <span style="font-size: 20px;">{{rqst.title}}</span>
                                        </el-col>
                                        <el-col :span="4">
                                            <div style="text-align:right;">
                                                {% if rqst.state == 0 %}
                                                <span style="color: rgb(31, 163, 31)">招标中</span>
                                                {% else %}
                                                <span style="color: rgb(189, 26, 26)">招标结束</span>
                                                {% endif %}
                                            </div>
                                        </el-col>
                                    </el-row>
                                    <div style="margin-top: 20px;">
                                        {% if rqst.publisher.name != username %}
                                        <el-button type="primary" @click="bid_visible = true">参与竞标</el-button>
                                        {% endif %}
                                    </div>
                                </div>

                                <div style="padding: 20px;">
                                    <el-collapse v-model="activeNames" @change="handleChange">
                                        <el-collapse-item title="发布者信息" name="1">
                                            <div style="padding: 20px;">
                                                <div style="display: flex; align-items:center;">
                                                    <el-avatar :size="small" :src="circleUrl"></el-avatar>
                                                    <span style="margin-left: 10px; margin-right: 10px;">{{rqst.publisher.name}}</span>
                                                    <el-divider direction="vertical"></el-divider>
                                                    <span style="font-size: 12px; margin-left: 10px;">共发布 {{rqst.publisher.pub_times}} 个需求</span> 
                                                </div>
                                                <div style="margin-top: 20px;">
                                                    <div style="font-size: 13px">个人简介：{{rqst.publisher.introduction}}</div>
                                                </div>
                                            </div>
                                        </el-collapse-item>
                                        <el-collapse-item title="需求描述" name="2">
                                            <div style="padding: 20px; font-size: 13px">
                                                <span>{{rqst.content}}</span>
                                            </div>
                                        </el-collapse-item>
                                    </el-collapse>
                                </div>
                            </div>
                        </el-col>
                    </el-row>
                </el-main>
            </el-container>
        </div>
    </body>

    <script src="https://unpkg.com/vue@2/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        import { headerData, headerAPI, circleUrl } from '../../static/help/javascript/help/header.js'

        new Vue({
            el: '#app',
            data: function() {
                return {
                    // 杂项
                    circleUrl: circleUrl,

                    headerData: headerData,    

                    pageData: {
                        bid: {
                            visible: false,
                            bid: '',
                            notify_new_bids: true,
                            rules: {
                                bid: [
                                    { required: true, message: '请输入竞标价', trigger: 'blur' },
                                ],
                            },
                        },
                    },
                }
            },

            methods: {
                // header需要的一些API
                signupSubmit() { headerAPI.signupSubmit.call(this); },
                loginSubmit() { headerAPI.loginSubmit.call(this); },
                exitSubmit() { headerAPI.exitSubmit.call(this); },
                requestSubmit() { headerAPI.requestSubmit.call(this); },
                editSubmit() { headerAPI.editSubmit.call(this); },

                bidSubmit() {
                    const data = {
                        bid: this.pageData.bid.bid,
                        notify_new_bids: this.pageData.bid.notify_new_bids,
                    }
                    const headers = {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                    var request_id = "{{rqst.id}}"
                    this.$refs['bidForm'].validate((valid) => {
                        if (valid) {
                            axios.post('/help/bidding/' + request_id + "/", data, { headers })
                            .then(response => {
                                if (response.data.message) {
                                    this.$message.error(response.data.message)
                                }
                                else if (response.data.success) {
                                    this.$message({
                                        message: '竞标成功',
                                        type: 'success',
                                    })
                                    this.pageData.bid.visible = false;
                                }
                            })
                        }
                    })
                },

                cooSubmit(id) {
                    const data = {
                        id: id,
                    }
                    const headers = {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                    axios.post('/help/cooperation/', data, { headers })
                    .then(response => {
                        if (response.data.message) {
                            this.$message.error(response.data.message)
                        }
                        else if (response.data.success) {
                            this.$message({
                                message: '合作关系建立成功',
                                type: 'success',
                            })
                            location.reload()
                        }
                    })
                }
            }
        })
      </script>
</html>
