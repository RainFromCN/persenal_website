<!DOCTYPE html>

{% load static %}
{% load project_extras %}

<html lang="en-US">
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width"/>
        <title>智囊 - 项目在线接单平台</title>
        <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
        <script src="https://unpkg.com/element-ui/lib/index.js"></script>
        <style>
            * {margin: 0; padding: 0}

            .el-menu-vertical:not(.el-menu--collapse) {
                width: 200px;
                min-height: 400px;
                margin-top: 20px;
            }

            .request-item {
                box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
                margin: 20px;
            }
        </style>
    </head>

    <body>
        <div id="app">
            <el-dialog width="80%" :visible.sync="browse_req_visible" title="我发布的需求">
                <el-row style="font-size: 14px; color: #606266; font-weight:bold;">
                    <el-col :span="18">标题</el-col>
                    <el-col :span="2">竞标人数</el-col>
                    <el-col :span="2">最低竞价</el-col>
                    <el-col :span="2">是否结束</el-col>
                </el-row>
                <el-divider></el-divider>
                {% for my_request in my_requests %}
                <el-row style="font-size: 13px; color: #606266;">
                    <el-col :span="18"><el-link href="{% url 'help:detail' my_request.id %}" target="_blank">{{my_request.title}}</el-link></el-col>
                    <el-col :span="2">{{my_request.num_bid}}</el-col>
                    <el-col :span="2">{{my_request.lowest_bid}}</el-col>
                    <el-col :span="2">{% if my_request.state == 0 %}否{% else %}是{% endif %}</el-col>
                </el-row>
                <el-divider></el-divider>
                {% endfor %}
            </el-dialog>

            <el-dialog width="80%" :visible.sync="browse_bid_visible" title="我发布的竞标">
                <el-row style="font-size: 14px; color: #606266; font-weight:bold;">
                    <el-col :span="18">标题</el-col>
                    <el-col :span="2">竞标人数</el-col>
                    <el-col :span="2">最低竞价</el-col>
                    <el-col :span="2">是否结束</el-col>
                </el-row>
                <el-divider></el-divider>
                {% for my_follow in my_follows %}
                <el-row style="font-size: 13px; color: #606266;">
                    <el-col :span="18"><el-link href="{% url 'help:detail' my_follow.request.id %}" target="_blank">{{my_follow.request.title}}</el-link></el-col>
                    <el-col :span="2">{{my_follow.request.num_bid}}</el-col>
                    <el-col :span="2">{{my_follow.request.lowest_bid}}</el-col>
                    <el-col :span="2">{% if my_follow.request.state == 0 %}否{% else %}是{% endif %}</el-col>
                </el-row>
                <el-divider></el-divider>
                {% endfor %}
            </el-dialog>

            <el-dialog width="80%" :visible.sync="edit_visible" title="编辑个人资料">
                <el-form ref="editForm" :model="editForm" :rules="editRules" label-width="100px" class="ruleForm">
                    <el-form-item label="手机号码" prop="tel">
                        <el-input v-model="editForm.tel" placeholder="请输入 11 位手机号码" maxlength="11" show-word-limit></el-input>
                    </el-form-item>
                    <el-form-item label="个人简介" prop="introduction">
                        <el-input type="textarea" :autosize="{minRows: 2, maxRows: 5}" placeholder="请输入个人简介" v-model="editForm.introduction" maxlength="100" show-word-limit></el-input>
                    </el-form-item>
                    <el-form-item>
                        <el-button type="primary" @click="editSubmit">更新</el-button>
                        <el-button @click="edit_visible = false">取消</el-button>
                    </el-form-item>
                </el-form>
            </el-dialog>

            <el-dialog width="80%" :visible.sync="form_visible" title="发布需求">
                <el-form ref="ruleForm" :model="ruleForm" :rules="rules" label-width="100px" class="ruleForm">
                    <el-form-item label="选择领域" prop="field">
                        <el-radio-group v-model="ruleForm.field">
                            {% for field in all_fields %}
                            <el-radio label="{{field.1}}"></el-radio>
                            {% endfor %}
                        </el-radio-group>
                    </el-form-item>
                    <el-form-item label="选择性质" prop="type">
                        <el-radio-group v-model="ruleForm.type">
                            {% for rtype in all_request_type %}
                            <el-radio label="{{rtype.1}}"></el-radio>
                            {% endfor %}
                        </el-radio-group>
                    </el-form-item>
                    <el-form-item label="标题" prop="title">
                        <el-input v-model="ruleForm.title" placeholder="请输入标题" maxlength="20" show-word-limit></el-input>
                    </el-form-item>
                    <el-form-item label="详细需求" prop="detail">
                        <el-input type="textarea" :autosize="{minRows: 2, maxRows: 5}" placeholder="请输入详细需求，建议分条列出" v-model="ruleForm.detail" maxlength="200" show-word-limit></el-input>
                    </el-form-item>
                    <el-form-item>
                        <el-button type="primary" @click="formSubmit">立即发布</el-button>
                        <el-button @click="form_visible = false">取消</el-button>
                    </el-form-item>
                </el-form>
            </el-dialog>

            <el-dialog :visible.sync="signup_visible" title="新用户注册">
                <template>
                    <el-input v-model="signup_username" placeholder="用户名" maxlength="20" show-word-limit> </el-input>
                    <el-input v-model="signup_password" placeholder="密码" show-password maxlength="20" show-word-limit> </el-input>
                    <el-input v-model="signup_confirm" placeholder="确认密码" show-password maxlength="20" show-word-limit></el-input>
                    <span slot="footer" class="dialog-footer">
                        <el-button @click="signup_visible = false">取消</el-button>
                        <el-button type="primary" @click="signupSubmit">确定</el-button>
                    </span>
                </template>
            </el-dialog>
                
            <el-dialog :visible.sync="login_visible" title="用户登录">
                <template>
                    <el-input v-model="login_username" placeholder="用户名" maxlength="20" show-word-limit> </el-input>
                    <el-input v-model="login_password" placeholder="密码" show-password maxlength="20" show-word-limit> </el-input>
                    <span slot="footer" class="dialog-footer">
                        <el-button @click="login_visible = false">取消</el-button>
                        <el-button type="primary" @click="loginSubmit">登录</el-button>
                    </span>
                </template>
            </el-dialog>

            <!--Header-->
            <el-container style="border: 1px solid #eeeeee; box-shadow: 0 0 10px #eeeeee">
                <el-row style="width: 100%;">
                    <el-col :span="2" >
                        <el-image style="width: 200px; height:auto;" src="{% static 'help/image/logo.png' %}"></el-image>
                    </el-col>
                    <el-col :span="22" >
                        <el-header style="display:flex; align-items:center; justify-content: flex-end; font-size: 12px;">
                            {% if username is None %}
                            <el-button type="text" @click="signup_visible = true">注册</el-button>
                            <el-button type="text" @click="login_visible = true">登录</el-button>
                            {% else %}
                            <el-dropdown>
                                <div style="display: flex; align-items: center;" class="el-dropdown-link">
                                    <el-avatar :size="small" :src="circleUrl"></el-avatar>
                                    <span style="margin-left: 10px">{{username}}</span>
                                    <i class="el-icon-arrow-down el-icon--right"></i>
                                </div>
                                <el-dropdown-menu slot="dropdown">
                                    <el-dropdown-item><el-button type="text" @click="browse_req_visible = true">我的需求</el-button></el-button></el-dropdown-item>
                                    <el-dropdown-item><el-button type="text" @click="browse_bid_visible = true">我的竞标</el-button></el-button></el-dropdown-item>
                                    <el-dropdown-item><el-button type="text" @click="edit_visible = true">个人资料</el-button></el-dropdown-item>
                                    <el-dropdown-item><el-button type="text" @click="exitSubmit">退出</el-button></el-dropdown-item>
                                </el-dropdown-menu>
                            </el-dropdown>
                            {% endif %}
                            <template>
                                <el-button style="margin-left: 20px" @click="form_visible = true">发布需求</el-button>
                            </template>
                        </el-header>
                    </el-col>
                </el-row>
            </el-container>

            <el-container>
                <!--侧边栏-->
                <el-menu ref='asideBar' default-active="1-{{current_field}}" default-openeds="['1']" class="el-menu-vertical" @open="menuOpen" @close="menuClose">
                    <el-submenu index="1">
                        <template slot="title">
                            <i class="el-icon-menu"></i>
                            <span>选择领域</span>
                        </template>
                        {% for field in all_fields %}
                        <el-menu-item index="1-{{field.0}}" @click="activateField({{field.0}})">{{field.1}}</el-menu-item>
                        {% endfor %}
                    </el-submenu>
                </el-menu>

                <el-main class="el-main">
                    <el-row>
                        <el-col :span="24">
                            {% for rqst in request %}
                            <div class="request-item">
                                <div style="padding: 10px;">
                                    {% if rqst.type == all_request_type.0.1 %}
                                    <el-tag type="success">{{rqst.type}}</el-tag>
                                    {% elif rqst.type == all_request_type.1.1 %}
                                    <el-tag type="warning">{{rqst.type}}</el-tag>
                                    {% elif rqst.type == all_request_type.2.1 %}
                                    <el-tag>{{rqst.type}}</el-tag>
                                    {% else %}
                                    <el-tag type="info">{{rqst.type}}</el-tag>
                                    {% endif %}
                                    <el-link href='{% url "help:detail" rqst.id %}' target="_blank" style="font-size: 18px; margin-left: 10px">{{rqst.title}}</el-link>
                                </div>
                                <div style="padding: 10px;">
                                    <el-row style="font-size: 12px;">
                                        <el-col :span="22">
                                            <span>{{rqst.timedelta}}</span>
                                            <el-divider direction="vertical"></el-divider>
                                            <span>{{rqst.num_bid}} 人竞标</span>
                                            <el-divider direction="vertical"></el-divider>
                                            <span>最低竞价 {{rqst.lowest_bid}} 元</span>
                                        </el-col>
                                        <el-col :span="2"></el-col>
                                    </el-row>
                                </div>
                            </div>
                            {% endfor %}
                        </el-col>
                    </el-row>
                </el-main>
            </el-container>
        </div>
    </body>

    <script src="https://unpkg.com/vue@2/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        new Vue({
          el: '#app',
          data: function() {
            var user_tel = "{{usr.tel}}";
            var user_introduction = "{{usr.introduction}}";

            return {

                // 杂项
                circleUrl: "https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png",

                // 与注册相关
                'signup_visible': false,
                'signup_username': '',
                'signup_password': '',
                'signup_confirm': '',

                // 与登录相关
                'login_visible': false,
                'login_username': '',
                'login_password': '',

                // 与发布需求相关
                'form_visible': false,

                // 与个人资料相关
                'edit_visible': false,
                'browse_req_visible': false,
                'browse_bid_visible': false,

                ruleForm: {
                    field: '',
                    type: '',
                    title: '',
                    detail: '',
                },

                editForm: {
                    tel: user_tel,
                    introduction: user_introduction,
                },

                rules: {
                    field: [
                        { required: true, message: '请选择所属的领域', trigger: 'change' },
                    ],
                    type: [
                        { required: true, message: '请选择活动区域', trigger: 'blur' },
                    ],
                    title: [
                        { required: true, message: '请输入需求的标题', trigger: 'blur' },
                        { min: 8, max: 20, message: '长度在 8 到 20 个字符之间', trigger: 'blur' },
                    ],
                    detail: [
                        { required: true, message: '请输入详细需求', trigger: 'blur' },
                    ],
                },

                editRules: {
                    tel: [
                        { required: true, message: '请输入手机号码', trigger: 'blur' },
                        { min: 11, max: 11, message: '长度为 11 位', trigger: 'change' },
                    ],
                    introduction: [
                        { required: true, message: '请输入个人简介', trigger: 'blur' },
                        { min: 20, max: 100, message: '长度在 20 到 100 个字符之间', trigger: 'change' },
                    ],
                }
            }
          },

          methods: {
            activateField(field) {
                const data = {
                    field: field,
                }
                const headers = {
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
                axios.post('/help/', data, { headers })
                location.reload()
            },

            signupSubmit() {
                const data = {
                    signup_username: this.signup_username,
                    signup_password: this.signup_password,
                    signup_confirm: this.signup_confirm,
                }
                const headers = {
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
                axios.post('/help/signup/', data, { headers })
                .then(response => {
                    // 处理返回后台的数据
                    if (response.data.message) {
                        this.$message.error(response.data.message)
                    }
                    else if (response.data.success) {
                        this.$message.success('注册成功')
                        this.signup_visible = false;
                        location.reload()
                    }
                })
                .catch(error => {
                    // 处理错误
                })
            },

            loginSubmit() {
                const data = {
                    login_username: this.login_username,
                    login_password: this.login_password,
                }
                const headers = {
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
                axios.post('/help/login/', data, { headers })
                .then(response => {
                    if (response.data.message) {
                        this.$message.error(response.data.message)
                    }
                    else if (response.data.success) {
                        this.login_visible = false;
                        location.reload()
                    }
                })                
                .catch(error => {
                    // 处理错误
                })
            },

            exitSubmit() {
                const data = {}
                const headers = {
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
                axios.post('/help/exit/', data, { headers })
                .then(response => {
                    location.reload()
                })
                .catch(error => {
                    // 处理错误
                })
            },

            formSubmit() {
                const data = {
                    field: this.ruleForm.field,
                    type: this.ruleForm.type,
                    title: this.ruleForm.title,
                    detail: this.ruleForm.detail,
                }
                const headers = {
                    'Content-Type': 'application/x-www-form-urlencoded'
                }

                this.$refs['ruleForm'].validate((valid) => {
                    if (valid) {
                        axios.post('/help/request_publish/', data, { headers })
                        .then(response => {
                            if (response.data.message) {
                                this.$message.error(response.data.message)
                            }
                            else if (response.data.success) {
                                this.$message({
                                    message: '发布成功，请在个人页面进行查看',
                                    type: 'success',
                                })
                                this.form_visible = false;
                            }
                        })
                    }
                })
            },

            editSubmit() {
                const data = {
                    tel: this.editForm.tel,
                    introduction: this.editForm.introduction,
                }
                const headers = {
                    'Content-Type': 'application/x-www-form-urlencoded'
                }

                this.$refs['editForm'].validate((valid) => {
                    if (valid) {
                        axios.post('/help/edit_information/', data, { headers })
                        .then(response => {
                            if (response.data.message) {
                                this.$message.error(response.data.message)
                            }
                            else if (response.data.success) {
                                this.$message({
                                    message: '个人资料修改成功',
                                    type: 'success',
                                })
                                this.edit_visible = false;
                            }
                        })
                    }
                })
            },
          }
        })
      </script>
<!-- 
    <el-container style="height: 500px; border: 1px solid #eee">
    
    </el-container>

    <body>
        <header>
            <div class="logo">
                <img src="{% static 'help/image/logo.png' %}"/>
            </div>

            

            <div class="右对齐">
            {% if username %}
                <div class="登录">
                    @{{username}}
                </div>
                <div class="登录"><a href="{% url 'project:exit' %}">退出</a></div>
            {% else %}
                <div class="登录">
                    <a href="{% url 'project:login' %}">登录</a>
                </div>
                <div class="注册">
                    <a href="{% url 'project:signup' %}">注册</a>
                </div>
            {% endif %}
                <el-button>发布信息</el-button>
            </div>
        </header>

        <img class='gradient' src="{% static 'project/image/gradient.png' %}" width=100%>

        <main>
            {% for project in projects %}
            <div class="project">
                {% with "project/image/"|addstr:project.prj_id|addstr:"/主图.jpg" as path %}
                <img src="{% static path %}">
                {% endwith %}
                <div class="intro">
                    <a class="title" href="{% url 'project:detail' project.prj_id 0 %}">
                        {{project.name}}
                    </a>
                    <div class="brief">
                        {{project.brief}}
                    </div>
                    <div class="tags">
                        {% for tag in project.projecttag_set.all %}
                        <div class="tag">{{tag}}</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="横线"></div>
            {% endfor %}
        </main>
    </body> -->
</html>
